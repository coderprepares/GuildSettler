<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冒险者公会 - 专票结算工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f3f4f6;
        }
        .adventure-card {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            transition: all 0.3s ease;
        }
        .input-focus:focus-within {
            border-color: #3b82f6;
            ring: 2px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Error shake animation */
        .shake {
            animation: shake 0.5s;
            border-color: #ef4444 !important;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 text-gray-800">

    <div class="w-full max-w-md adventure-card rounded-2xl shadow-xl overflow-hidden border border-gray-200">
        <!-- Header -->
        <div class="bg-blue-600 p-6 text-white text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full opacity-10">
                <i class="fas fa-coins text-8xl absolute -left-4 -top-4"></i>
                <i class="fas fa-calculator text-8xl absolute -right-4 -bottom-4"></i>
            </div>
            <h1 class="text-2xl font-bold relative z-10">冒险者公会结算台</h1>
            <p class="text-blue-100 text-sm mt-1 relative z-10">专票金额计算工具</p>
        </div>

        <!-- Content -->
        <div class="p-6 space-y-6">
            
            <!-- Input Area -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">冒险币数量 (M)</label>
                    <div class="relative input-focus rounded-lg border border-gray-300 bg-white overflow-hidden flex items-center" id="coinContainer">
                        <span class="pl-3 text-gray-400"><i class="fas fa-coins"></i></span>
                        <input type="number" id="coinAmount" class="w-full p-3 outline-none" placeholder="请输入数量" step="1">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">您的开票税点 F (%)</label>
                    <div class="relative input-focus rounded-lg border border-gray-300 bg-white overflow-hidden flex items-center" id="taxContainer">
                        <span class="pl-3 text-gray-400"><i class="fas fa-percent"></i></span>
                        <input type="number" id="taxRate" class="w-full p-3 outline-none" placeholder="请输入税点 (如 1, 3)" step="0.01">
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="setRate(1)" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-gray-600 transition">1% (普票/专票)</button>
                        <button onclick="setRate(3)" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-gray-600 transition">3% (小规模)</button>
                        <button onclick="setRate(6)" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-gray-600 transition">6% (服务业)</button>
                        <button onclick="setRate(13)" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-gray-600 transition">13% (一般纳税人)</button>
                    </div>
                </div>
            </div>

            <!-- Action -->
            <button onclick="calculate()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md hover:shadow-lg transition transform hover:-translate-y-0.5 active:translate-y-0">
                计算结算金额
            </button>

            <!-- Result Area (Hidden by default) -->
            <div id="resultArea" class="hidden animate-fade-in-up">
                <div class="border-t border-dashed border-gray-300 my-4"></div>
                
                <div class="bg-green-50 rounded-xl p-4 border border-green-100 text-center relative">
                    <p class="text-green-800 text-sm font-medium uppercase tracking-wide">最终成交价 (R)</p>
                    <div class="text-3xl font-bold text-green-700 mt-1">
                        ¥ <span id="finalResult">0.00</span>
                    </div>
                    <!-- Valid Indicator -->
                    <div id="perfectMatchBadge" class="hidden absolute top-2 right-2 bg-green-200 text-green-800 text-xs px-2 py-1 rounded-full font-bold">
                        <i class="fas fa-check-circle"></i> 双整完美
                    </div>
                    <p class="text-xs text-green-600 mt-1" id="finalResultRounded">取整: 0</p>
                </div>

                <!-- Recommendation Section -->
                <div id="recommendationBox" class="mt-4 bg-indigo-50 rounded-lg p-4 border border-indigo-100 hidden">
                    <div class="flex items-start gap-3">
                        <div class="mt-1 text-indigo-500"><i class="fas fa-magic"></i></div>
                        <div class="flex-1">
                            <h3 class="text-sm font-bold text-indigo-800">双整方案推荐 (M和R均为整数)</h3>
                            <p class="text-xs text-indigo-700 mt-1 leading-relaxed">
                                为保证 <strong>冒险币</strong> 和 <strong>成交价</strong> 都是整数，
                                建议将冒险币调整为：
                            </p>
                            <div class="flex items-center justify-between mt-3 bg-white p-2 rounded border border-indigo-200">
                                <div class="text-left">
                                    <div class="text-xs text-gray-500">建议冒险币</div>
                                    <div class="font-mono font-bold text-indigo-900 text-lg" id="recCoinAmount">0</div>
                                </div>
                                <div class="text-right border-l pl-3 border-gray-200">
                                    <div class="text-xs text-gray-500">对应成交价</div>
                                    <div class="font-mono font-bold text-green-700 text-lg">¥<span id="recPrice">0</span></div>
                                </div>
                            </div>
                            <button onclick="applyRecommendation()" class="w-full mt-2 text-xs bg-indigo-200 hover:bg-indigo-300 text-indigo-900 py-2 rounded transition font-medium">
                                采纳此方案 (填入上方)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Breakdown Details -->
                <div class="mt-4 bg-gray-50 rounded-lg p-4 text-sm space-y-2 border border-gray-200">
                    <div class="flex justify-between">
                        <span class="text-gray-500">原始冒险币 (M)</span>
                        <span class="font-medium" id="displayM">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 flex items-center gap-1">
                            不含税基数 
                            <span class="text-xs bg-gray-200 px-1 rounded" title="除以 1.06">÷1.06</span>
                        </span>
                        <span class="font-medium" id="displayBase">0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">加税金额 (+<span id="displayRate">0</span>%)</span>
                        <span class="font-medium text-blue-600" id="displayTaxAmt">+0.00</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-2 text-center pt-2 border-t border-gray-200">
                        公式: M ÷ 1.06 × (1 + F%)
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Euclidean algorithm for GCD
        function gcd(a, b) {
            return b === 0 ? a : gcd(b, a % b);
        }

        function setRate(val) {
            document.getElementById('taxRate').value = val;
            const inputContainer = document.getElementById('taxContainer');
            inputContainer.classList.add('bg-blue-50');
            // Remove error state if exists
            inputContainer.classList.remove('shake');
            setTimeout(() => inputContainer.classList.remove('bg-blue-50'), 200);
            
            // Only calc if coin amount is also present
            if(document.getElementById('coinAmount').value) {
                calculate();
            }
        }

        function calculate() {
            const coinInput = document.getElementById('coinAmount');
            const taxInput = document.getElementById('taxRate');
            const coinContainer = document.getElementById('coinContainer');
            const taxContainer = document.getElementById('taxContainer');

            // Reset shake classes
            coinContainer.classList.remove('shake');
            taxContainer.classList.remove('shake');

            // Check for empty values
            let hasError = false;
            if (!coinInput.value) {
                coinContainer.classList.add('shake');
                hasError = true;
            }
            if (!taxInput.value) {
                taxContainer.classList.add('shake');
                hasError = true;
            }

            if (hasError) {
                // Clear animations after they run so they can run again
                setTimeout(() => {
                    coinContainer.classList.remove('shake');
                    taxContainer.classList.remove('shake');
                }, 500);
                return;
            }

            // Get values
            const M = parseFloat(coinInput.value);
            const F_val = parseFloat(taxInput.value);
            const resultArea = document.getElementById('resultArea');

            // Calculation Logic (Standard)
            const baseAmount = M / 1.06;
            const multiplier = 1 + (F_val / 100);
            const finalAmount = baseAmount * multiplier;
            const taxAmount = finalAmount - baseAmount;

            // Update UI - Main Result
            resultArea.classList.remove('hidden');
            document.getElementById('finalResult').innerText = finalAmount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('finalResultRounded').innerText = `取整: ${Math.round(finalAmount)}`;
            
            document.getElementById('displayM').innerText = M.toLocaleString();
            document.getElementById('displayBase').innerText = baseAmount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('displayRate').innerText = F_val;
            document.getElementById('displayTaxAmt').innerText = '+' + taxAmount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // --- Double Integer Recommendation Logic ---
            
            let num = Math.round((100 + F_val) * 100); 
            let den = 106 * 100; 

            const commonDivisor = gcd(num, den);
            const simplifiedDen = den / commonDivisor; // This is the step size for M
            
            const isMInteger = Math.abs(M - Math.round(M)) < 0.001;
            const isDivisible = Math.abs((M % simplifiedDen)) < 0.001 || Math.abs((M % simplifiedDen) - simplifiedDen) < 0.001;
            
            const perfectBadge = document.getElementById('perfectMatchBadge');
            const recBox = document.getElementById('recommendationBox');

            if (isMInteger && isDivisible && M > 0) {
                // Perfect match!
                perfectBadge.classList.remove('hidden');
                recBox.classList.add('hidden');
            } else {
                perfectBadge.classList.add('hidden');
                
                // Find largest multiple of simplifiedDen <= M
                let targetM = Math.floor(M / simplifiedDen) * simplifiedDen;
                
                if (targetM === 0) targetM = simplifiedDen;

                if (Math.abs(targetM - M) < 0.01) {
                     perfectBadge.classList.remove('hidden');
                     recBox.classList.add('hidden');
                } else {
                    const targetR = targetM * (100 + F_val) / 106;
                    
                    document.getElementById('recCoinAmount').innerText = targetM;
                    document.getElementById('recPrice').innerText = Math.round(targetR);
                    recBox.classList.remove('hidden');
                }
            }
        }

        function applyRecommendation() {
            const recVal = document.getElementById('recCoinAmount').innerText;
            document.getElementById('coinAmount').value = recVal;
            const input = document.getElementById('coinContainer');
            input.classList.add('bg-indigo-50');
            setTimeout(() => input.classList.remove('bg-indigo-50'), 300);
            calculate();
        }

        // Add Enter key listener
        document.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                calculate();
            }
        });

    </script>
</body>
</html>